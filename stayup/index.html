<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stay Up</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        #timer {
            font-size: 48px;
            margin: 20px 0;
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>Stay Up</h1>
    <div id="timer">00:00</div>
    <button id="startPauseBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <script>
        let timerInterval = null;
        let remainingTime = 0;
        let isPaused = true;

        function playSound() {
            const audio = new Audio("alarm.mp3"); // Updated sound effect
            audio.play();
        }

        function startTimer(duration, onUpdate, onComplete) {
            const endTime = Date.now() + duration * 60 * 1000;

            function updateTimer() {
                if (isPaused) return;
                const remaining = endTime - Date.now();

                if (remaining <= 0) {
                    onUpdate("00:00");
                    clearInterval(timerInterval);
                    if (onComplete) {
                        playSound();
                        onComplete();
                    }
                } else {
                    const mins = Math.floor(remaining / (60 * 1000));
                    const secs = Math.floor((remaining % (60 * 1000)) / 1000);
                    onUpdate(`${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`);
                }
            }

            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
            remainingTime = 0;
            isPaused = true;
            document.getElementById("timer").textContent = "00:00";
            document.getElementById("startPauseBtn").textContent = "Start";
        }

        function toggleTimer() {
            const button = document.getElementById("startPauseBtn");
            if (isPaused) {
                isPaused = false;
                if (remainingTime === 0) {
                    startRoutine();
                }
                button.textContent = "Pause";
            } else {
                isPaused = true;
                button.textContent = "Start";
            }
        }

        function updateDisplay(time) {
            document.getElementById("timer").textContent = time;
        }

        function notify(message, callback) {
            //playSound();
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(message);
            } else if ("Notification" in window && Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification(message);
                    } else {
                        alert(message);
                    }
                });
            } else {
                alert(message);
            }
            if (callback) callback();
        }

        function askQuestion(question, yesCallback, noCallback) {
            const response = confirm(question);
            if (response && yesCallback) {
                yesCallback();
            } else if (!response && noCallback) {
                noCallback();
            }
        }

        function startRoutine() {
            // Start 1 hour timer
            startTimer(60, updateDisplay, () => {
                notify("Stand up!", () => {
                    // Start 30-minute timer
                    startTimer(30, updateDisplay, () => {
                        askQuestion("Exercise? (OK for Yes, Cancel for No)", () => {
                            // Start 5-minute exercise timer
                            startTimer(5, updateDisplay, () => {
                                notify("Sit down!", startRoutine);
                            });
                        }, () => {
                            notify("Sit down!", startRoutine);
                        });
                    });
                });
            });
        }

        document.getElementById("startPauseBtn").addEventListener("click", toggleTimer);
        document.getElementById("stopBtn").addEventListener("click", stopTimer);
    </script>
</body>
</html>
